#include <Wire.h>                      //IIC通讯头文件
#include <Adafruit_PWMServoDriver.h> //16路舵机控制板头文件
//以这种方式调用，它使用默认地址0x40。
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();
#define SERVOMIN  680   //这是“最小”高电平占空比计数（在4096中）
#define SERVOMAX  2200   //这是“最大”高电平占空比计数（在4096中）
//前进步态帧数据
char wk[43][8]= {
 12, 59,-55,-49, 23, 24, -2,-12,
 15, 59,-63,-47, 22, 27, -8,-11,
 18, 59,-67,-45, 20, 30,-20,-11,
 21, 59,-66,-43, 18, 34,-33,-10,
 24, 59,-64,-40, 16, 38,-37,-10,
 27, 58,-62,-37, 15, 43,-41,-11,
 30, 57,-60,-35, 13, 47,-45,-12,
 32, 58,-57,-32, 13, 47,-48,-13,
 35, 60,-57,-29, 12, 45,-47,-14,
 38, 62,-58,-26, 12, 41,-42,-15,
 40, 65,-59,-23, 11, 36,-37,-16,
 43, 66,-59,-20, 11, 32,-33,-18,
 45, 67,-59,-17, 11, 18,-30,-20,
 47, 62,-59,-14, 11,  7,-26,-22,
 49, 53,-59,-12, 12,  1,-24,-24,
 51, 40,-58,-12, 13,  2,-21,-22,
 52, 26,-57,-12, 14,  7,-19,-20,
 54, 17,-55,-14, 15, 13,-18,-16,
 55, 15,-54,-16, 17, 16,-16,-15,
 57, 13,-53,-23, 18, 19,-15, -9,
 58, 12,-51,-38, 21, 22,-13, -2,
 58, 12,-49,-51, 23, 24,-12, -1,
 59, 13,-47,-60, 26, 23,-11, -6,
 59, 17,-45,-66, 29, 20,-11,-15,
 59, 20,-43,-66, 32, 18,-10,-33,
 59, 23,-41,-65, 37, 17,-10,-35,
 58, 26,-38,-63, 41, 15,-11,-40,
 57, 29,-35,-61, 46, 14,-12,-44,
 58, 32,-33,-58, 47, 13,-13,-47,
 59, 34,-30,-57, 47, 12,-14,-48,
 61, 37,-27,-58, 43, 12,-15,-43,
 64, 40,-24,-59, 38, 11,-16,-38,
 65, 42,-21,-59, 34, 11,-17,-34,
 67, 44,-18,-59, 23, 11,-19,-31,
 64, 46,-15,-59, 10, 11,-21,-27,
 56, 48,-12,-59,  3, 12,-23,-24,
 45, 50,-12,-58,  1, 13,-23,-22,
 31, 52,-12,-57,  5, 14,-20,-19,
 18, 53,-14,-56, 13, 15,-17,-17,
 16, 55,-16,-55, 15, 17,-15,-16,
 14, 57,-18,-53, 17, 17,-13,-15,
 12, 57,-33,-52, 21, 20, -4,-14,
 12, 58,-47,-50, 23, 22,  0,-13,
};
//舵机校准偏角数据
char cal[16]={-6,-14,7,0,0,0,0,0,1,9,-3,3,6,-6,7,-6};
//舵机旋转方向
int8_t rotationDirections[] = {1, -1, 1, 1,
                               1, -1, 1, -1,
                               1, -1, -1, 1,
                               -1, 1, 1, -1
                              };
//关节映射表
byte pins[] = {4, 3, 11, 12,
               5, 2, 13, 10,
               6, 1, 14, 9,
               7, 0, 15, 8
              };
//将角度数据转换成高电平占空比
int S2P(int angle){
  float p=0.0;
  p=(1520/150)*angle+680+760;
  return int(p);
}

void setup() {
   Serial.begin(57600);//打开串口
   pwm.begin();       //初始化PCA9685
   pwm.setPWMFreq(240);  //设置频率60Hz  
}

void loop() {
  //循环一次前进步态
  for(int i=0;i<=42;i++)//一共43帧
  {
    for(int j=0;j<=7;j++)//每帧8个舵机角度
    {      
      Serial.print(int(wk[i][j]));
      //具体舵机角度=步态帧中舵机角度数据*旋转方向+舵机校准偏角+75
      //每次从8号关节舵机开始，执行到16号关节舵机，为一帧
      pwm.setPWM(pins[8+j],0,S2P((int(wk[i][j])+cal[8+j])*rotationDirections[j+8]));
      Serial.print(',');
    }
    delay(100);
    Serial.println();
  }
  delay(500000000);//只执行一次，如果想循环执行，则需要将此行注释掉
}
