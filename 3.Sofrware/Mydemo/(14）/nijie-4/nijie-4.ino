#include <Wire.h>                      //IIC通讯头文件
#include <Adafruit_PWMServoDriver.h> //16路舵机控制板头文件
//以这种方式调用，它使用默认地址0x40。
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();
#define SERVOMIN  680   //这是“最小”高电平占空比计数（在4096中）
#define SERVOMAX  2200   //这是“最大”高电平占空比计数（在4096中）
//前进步态帧数据
char wk[36][8]= {
22,-29,18,-22,28,84,-62,-29,
22,-22,13,-22,25,72,-55,-30,
21,-17,9,-21,24,65,-50,-31,
20,-14,6,-20,24,60,-45,-32,
18,-10,3,-18,25,56,-42,-34,
16,-7,0,-16,26,52,-39,-35,
14,-4,-3,-14,27,49,-36,-37,
12,-2,-5,-12,28,46,-33,-39,
10,1,-8,-10,29,44,-31,-41,
8,3,-10,-8,31,41,-29,-44,
5,6,-12,-5,33,39,-28,-46,
3,8,-14,-3,36,37,-27,-49,
0,10,-16,0,39,35,-26,-52,
-3,12,-18,3,42,34,-25,-56,
-6,14,-20,6,45,32,-24,-60,
-9,17,-21,9,50,31,-24,-65,
-13,18,-22,13,55,30,-25,-72,
-18,20,-22,18,62,29,-28,-84,
-29,22,-20,29,84,28,-29,-62,
-22,22,-18,22,72,25,-30,-55,
-17,21,-17,17,65,24,-31,-50,
-14,20,-14,14,60,24,-32,-45,
-10,18,-12,10,56,25,-34,-42,
-7,16,-10,7,52,26,-35,-39,
-4,14,-8,4,49,27,-37,-36,
-2,12,-6,2,46,28,-39,-33,
1,10,-3,-1,44,29,-41,-31,
3,8,-1,-3,41,31,-44,-29,
6,5,2,-6,39,33,-46,-28,
8,3,4,-8,37,36,-49,-27,
10,0,7,-10,35,39,-52,-26,
12,-3,10,-12,34,42,-56,-25,
14,-6,14,-14,32,45,-60,-24,
17,-9,17,-17,31,50,-65,-24,
18,-13,22,-18,30,55,-72,-25,
20,-18,29,-20,29,62,-84,-28
};
//舵机校准偏角数据
char cal[16]={-6,-14,7,0,0,0,0,0,1,9,-3,3,6,-6,7,-6};
//舵机旋转方向
int8_t rotationDirections[] = {1, -1, 1, 1,
                               1, -1, 1, -1,
                               1, -1, -1, 1,
                               -1, 1, 1, -1
                              };
//关节映射表
byte pins[] = {4, 3, 11, 12,
               5, 2, 13, 10,
               6, 1, 14, 9,
               7, 0, 15, 8
              };
//将角度数据转换成高电平占空比
int S2P(int angle){
  float p=0.0;
  p=(1520/150)*angle+680+760;
  return int(p);
}

void setup() {
   Serial.begin(57600);//打开串口
   pwm.begin();       //初始化PCA9685
   pwm.setPWMFreq(240);  //设置频率60Hz  
}

void loop() {
  //循环一次前进步态
  for(int i=0;i<=35;i++)//一共43帧
  {
    for(int j=0;j<=7;j++)//每帧8个舵机角度
    {      
      Serial.print(int(wk[i][j]));
      //具体舵机角度=步态帧中舵机角度数据*旋转方向+舵机校准偏角+75
      //每次从8号关节舵机开始，执行到16号关节舵机，为一帧
      pwm.setPWM(pins[8+j],0,S2P((int(wk[i][j])+cal[8+j])*rotationDirections[j+8]));
      Serial.print(',');
    }
    delay(5);
    Serial.println();
  }
  //delay(1000);//只执行一次，如果想循环执行，则需要将此行注释掉
}
