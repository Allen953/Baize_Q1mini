#include <Wire.h>                      //IIC通讯头文件
#include <Adafruit_PWMServoDriver.h> //16路舵机控制板头文件
//以这种方式调用，它使用默认地址0x40。
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();
#define SERVOMIN  680   //这是“最小”高电平占空比计数（在4096中）
#define SERVOMAX  2200   //这是“最大”高电平占空比计数（在4096中）
//前进步态帧数据
char wk[36][8]= {
22,22,-24,-22,28,28,-24,-29,
22,22,-25,-22,25,28,-22,-30,
21,22,-25,-21,24,28,-21,-31,
20,22,-26,-20,24,28,-21,-32,
18,22,-26,-18,25,28,-20,-34,
16,22,-26,-16,26,28,-20,-35,
14,22,-26,-14,27,28,-19,-37,
12,22,-26,-12,28,28,-19,-39,
10,22,-26,-10,29,28,-19,-41,
8,22,-26,-8,31,28,-19,-44,
5,22,-26,-5,33,28,-19,-46,
3,22,-26,-3,36,28,-20,-49,
0,22,-26,0,39,28,-20,-52,
-3,22,-26,3,42,28,-21,-56,
-6,22,-25,6,45,28,-21,-60,
-9,22,-25,9,50,28,-22,-65,
-13,22,-24,13,55,28,-24,-72,
-18,22,-22,18,62,28,-28,-84,
-29,22,-22,29,84,28,-28,-62,
-22,24,-22,22,72,24,-28,-55,
-17,25,-22,17,65,22,-28,-50,
-14,25,-22,14,60,21,-28,-45,
-10,26,-22,10,56,21,-28,-42,
-7,26,-22,7,52,20,-28,-39,
-4,26,-22,4,49,20,-28,-36,
-2,26,-22,2,46,19,-28,-33,
1,26,-22,-1,44,19,-28,-31,
3,26,-22,-3,41,19,-28,-29,
6,26,-22,-6,39,19,-28,-28,
8,26,-22,-8,37,19,-28,-27,
10,26,-22,-10,35,20,-28,-26,
12,26,-22,-12,34,20,-28,-25,
14,26,-22,-14,32,21,-28,-24,
17,25,-22,-17,31,21,-28,-24,
18,25,-22,-18,30,22,-28,-25,
20,24,-22,-20,29,24,-28,-28
};
//舵机校准偏角数据
char cal[16]={-6,-14,7,0,0,0,0,0,1,9,-3,3,6,-6,7,-6};
//舵机旋转方向
int8_t rotationDirections[] = {1, -1, 1, 1,
                               1, -1, 1, -1,
                               1, -1, -1, 1,
                               -1, 1, 1, -1
                              };
//关节映射表
byte pins[] = {4, 3, 11, 12,
               5, 2, 13, 10,
               6, 1, 14, 9,
               7, 0, 15, 8
              };
//将角度数据转换成高电平占空比
int S2P(int angle){
  float p=0.0;
  p=(1520/150)*angle+680+760;
  return int(p);
}

void setup() {
   Serial.begin(57600);//打开串口
   pwm.begin();       //初始化PCA9685
   pwm.setPWMFreq(240);  //设置频率60Hz  
}

void loop() {
  //循环一次前进步态
  for(int i=0;i<=35;i++)//一共43帧
  {
    for(int j=0;j<=7;j++)//每帧8个舵机角度
    {      
      Serial.print(int(wk[i][j]));
      //具体舵机角度=步态帧中舵机角度数据*旋转方向+舵机校准偏角+75
      //每次从8号关节舵机开始，执行到16号关节舵机，为一帧
      pwm.setPWM(pins[8+j],0,S2P((int(wk[i][j])+cal[8+j])*rotationDirections[j+8]));
      Serial.print(',');
    }
    delay(25);
    Serial.println();
  }
  //delay(1000);//只执行一次，如果想循环执行，则需要将此行注释掉
}
